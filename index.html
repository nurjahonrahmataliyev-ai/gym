<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleep & Screen Tracker</title>
    <!-- Offline Fallback: Tailwind & Chart.js would normally be remote, 
         but for a fully offline app, these are usually local files. 
         I am using the CDN links below, but the app logic is built 
         to handle the "laptop local storage" requirement. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">

    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        /* Light Theme */
        body, .app-card {
            background-color: #f8fafc;
            color: #1e293b;
        }
        .app-card {
            background-color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }
        .input-field {
            background-color: #f1f5f9;
            border: 1px solid #cbd5e1;
        }
        /* Dark Theme */
        body.dark, .dark .app-card {
            background-color: #0f172a;
            color: #f1f5f9;
        }
        .dark .app-card {
            background-color: #1e293b;
            border: 1px solid #334155;
        }
        .dark .input-field {
            background-color: #334155;
            color: #f1f5f9;
            border: 1px solid #475569;
        }
        .success-text { color: #10b981; }
        .danger-text { color: #ef4444; }
    </style>
</head>
<body>
    <div class="container min-h-screen">
        <!-- Header -->
        <header class="py-6 flex justify-between items-center border-b border-gray-200 dark:border-gray-800 mb-6">
            <div>
                <h1 class="text-3xl font-extrabold text-indigo-600 dark:text-indigo-400">Sleep Optimizer</h1>
                <p class="text-sm text-gray-500">Local Privacy Mode â€¢ Fixed Schedule Tracker</p>
            </div>
            <button id="theme-toggle" class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 transition">
                <span id="theme-icon">ðŸŒ™</span>
            </button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Logging Form -->
            <div class="app-card p-6 rounded-2xl lg:col-span-1 h-fit">
                <h2 class="text-xl font-bold mb-4">Daily Log</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Date</label>
                        <input type="date" id="date-input" class="w-full p-2 rounded-lg input-field outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">When did you go to bed?</label>
                        <input type="time" id="bed-time-input" class="w-full p-2 rounded-lg input-field outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">When did you wake up?</label>
                        <input type="time" id="wake-time-input" class="w-full p-2 rounded-lg input-field outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Screen time before bed (mins)</label>
                        <input type="number" id="screen-time-input" placeholder="Minutes" class="w-full p-2 rounded-lg input-field outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button id="log-btn" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition transform active:scale-95 shadow-lg shadow-indigo-500/30">
                        Save to Local Storage
                    </button>
                    <p id="msg" class="text-center text-sm font-medium h-4"></p>
                </div>
            </div>

            <!-- Dashboard -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Stats Summary -->
                <div class="grid grid-cols-3 gap-4">
                    <div class="app-card p-4 rounded-xl text-center">
                        <p class="text-xs text-gray-400 font-bold uppercase">Avg Sleep</p>
                        <p id="stat-avg-sleep" class="text-xl font-bold">0h</p>
                    </div>
                    <div class="app-card p-4 rounded-xl text-center">
                        <p class="text-xs text-gray-400 font-bold uppercase">Avg Screen</p>
                        <p id="stat-avg-screen" class="text-xl font-bold text-amber-500">0m</p>
                    </div>
                    <div class="app-card p-4 rounded-xl text-center">
                        <p class="text-xs text-gray-400 font-bold uppercase">Consistency</p>
                        <p id="stat-consistency" class="text-xl font-bold">--</p>
                    </div>
                </div>

                <!-- MAIN GRAPH: Sleep Hours -->
                <div class="app-card p-6 rounded-2xl">
                    <h3 class="text-lg font-bold mb-4 text-indigo-500">Main: Sleep Duration (Hours)</h3>
                    <div class="h-64">
                        <canvas id="sleepTrendChart"></canvas>
                    </div>
                </div>

                <!-- SIDE-BY-SIDE GRAPHS: Bedtime and Screen Use -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="app-card p-6 rounded-2xl">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-bold uppercase text-gray-500">Bedtime Score</h3>
                            <span class="text-[10px] text-gray-400">Up=Early / Down=Late</span>
                        </div>
                        <div class="h-40">
                            <canvas id="bedtimeTrendChart"></canvas>
                        </div>
                    </div>
                    <div class="app-card p-6 rounded-2xl">
                        <h3 class="text-sm font-bold uppercase text-gray-500 mb-4">Screen Use (m)</h3>
                        <div class="h-40">
                            <canvas id="screenTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History -->
        <div class="app-card mt-6 p-6 rounded-2xl mb-10">
            <h2 class="text-xl font-bold mb-4">Your Local Records</h2>
            <div id="history-list" class="divide-y divide-gray-100 dark:divide-gray-700">
                <!-- Logged items will appear here -->
            </div>
        </div>
    </div>

    <script>
        // Use a unique key for laptop's localStorage
        const STORAGE_KEY = 'offline_sleep_optimizer_v1';
        let records = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        
        let sleepChart = null;
        let screenChart = null;
        let bedtimeChart = null;

        const logBtn = document.getElementById('log-btn');
        const themeBtn = document.getElementById('theme-toggle');
        const msg = document.getElementById('msg');

        window.onload = () => {
            document.getElementById('date-input').value = new Date().toISOString().split('T')[0];
            updateUI();
        };

        themeBtn.onclick = () => {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            document.getElementById('theme-icon').innerText = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
            renderCharts();
        };

        logBtn.onclick = () => {
            const date = document.getElementById('date-input').value;
            const bedTime = document.getElementById('bed-time-input').value;
            const wakeTime = document.getElementById('wake-time-input').value;
            const screenTime = parseInt(document.getElementById('screen-time-input').value) || 0;

            if (!date || !bedTime || !wakeTime) {
                showMsg("Please enter both sleep and wake times.", "danger-text");
                return;
            }

            const duration = calcDuration(bedTime, wakeTime);
            const bedScore = calcBedScore(bedTime);

            const entry = { date, bedTime, wakeTime, screenTime, duration, bedScore };
            
            records.push(entry);
            // Sort by date so graphs look correct
            records.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Save to Laptop Local Storage
            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
            
            updateUI();
            showMsg("Record Saved Locally", "success-text");
            
            // Reset fields
            document.getElementById('bed-time-input').value = '';
            document.getElementById('wake-time-input').value = '';
            document.getElementById('screen-time-input').value = '';
        };

        function calcBedScore(time) {
            const [h, m] = time.split(':').map(Number);
            let totalMins = h * 60 + m;
            // Treat early morning sleep (00:00 to 12:00) as later than late night
            if (h < 12) totalMins += 1440;
            // Negative so that 11 PM (-1380) is "higher" than 1 AM (-1500)
            return -totalMins; 
        }

        function calcDuration(start, end) {
            const [sH, sM] = start.split(':').map(Number);
            const [eH, eM] = end.split(':').map(Number);
            let diff = (eH * 60 + eM) - (sH * 60 + sM);
            if (diff < 0) diff += 1440; 
            return diff;
        }

        function showMsg(text, cls) {
            msg.innerText = text;
            msg.className = "text-center text-sm font-medium " + cls;
            setTimeout(() => msg.innerText = "", 3000);
        }

        function updateUI() {
            renderHistory();
            renderStats();
            renderCharts();
        }

        function renderStats() {
            if (!records.length) return;
            const avgSleep = records.reduce((a, b) => a + b.duration, 0) / records.length;
            const avgScreen = records.reduce((a, b) => a + b.screenTime, 0) / records.length;
            
            document.getElementById('stat-avg-sleep').innerText = (avgSleep / 60).toFixed(1) + 'h';
            document.getElementById('stat-avg-screen').innerText = Math.round(avgScreen) + 'm';
            
            const lastThree = records.slice(-3);
            if (lastThree.length > 1) {
                const bedScores = lastThree.map(r => r.bedScore);
                const variance = Math.max(...bedScores) - Math.min(...bedScores);
                document.getElementById('stat-consistency').innerText = variance <= 60 ? 'High' : 'Low';
            }
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = records.slice().reverse().map((r, i) => `
                <div class="py-3 flex justify-between items-center">
                    <div>
                        <p class="font-bold text-sm text-gray-600 dark:text-gray-300">${r.date}</p>
                        <p class="text-xs text-gray-400">Bed: ${r.bedTime} | Wake: ${r.wakeTime}</p>
                    </div>
                    <div class="text-right flex items-center gap-4">
                        <div class="text-right">
                            <p class="font-bold text-indigo-500 text-sm">${(r.duration/60).toFixed(1)}h sleep</p>
                            <p class="text-xs text-amber-500">${r.screenTime}m screen</p>
                        </div>
                        <button onclick="deleteRecord(${records.length - 1 - i})" class="p-2 text-gray-300 hover:text-red-500 transition">âœ•</button>
                    </div>
                </div>
            `).join('');
        }

        window.deleteRecord = (index) => {
            records.splice(index, 1);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
            updateUI();
        };

        function renderCharts() {
            if (records.length === 0) return;
            
            const isDark = document.body.classList.contains('dark');
            const mainColor = isDark ? '#818cf8' : '#4f46e5';
            const screenColor = '#f59e0b';
            const bedtimeColor = '#10b981';
            const textColor = isDark ? '#94a3b8' : '#64748b';
            const gridColor = isDark ? '#334155' : '#f1f5f9';

            const labels = records.map(r => r.date.split('-').slice(1).join('/'));
            
            // MAIN: Sleep Duration Chart
            if (sleepChart) sleepChart.destroy();
            const ctx1 = document.getElementById('sleepTrendChart').getContext('2d');
            sleepChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Total Sleep Hours',
                        data: records.map(r => (r.duration / 60).toFixed(1)),
                        borderColor: mainColor,
                        backgroundColor: mainColor + '11',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointBackgroundColor: mainColor
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { 
                            beginAtZero: false,
                            ticks: { color: textColor }, 
                            grid: { color: gridColor } 
                        },
                        x: { ticks: { color: textColor }, grid: { display: false } }
                    }
                }
            });

            // Bedtime Score Chart
            if (bedtimeChart) bedtimeChart.destroy();
            const ctx0 = document.getElementById('bedtimeTrendChart').getContext('2d');
            bedtimeChart = new Chart(ctx0, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Schedule Score',
                        data: records.map(r => r.bedScore),
                        borderColor: bedtimeColor,
                        borderDash: [5, 5],
                        tension: 0.4,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: { callbacks: { label: (ctx) => `Bedtime: ${records[ctx.dataIndex].bedTime}` } }
                    },
                    scales: { 
                        y: { display: false },
                        x: { ticks: { color: textColor }, grid: { display: false } }
                    }
                }
            });

            // Screen Chart
            if (screenChart) screenChart.destroy();
            const ctx2 = document.getElementById('screenTrendChart').getContext('2d');
            screenChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Minutes',
                        data: records.map(r => r.screenTime),
                        borderColor: screenColor,
                        backgroundColor: screenColor + '11',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { ticks: { color: textColor }, grid: { color: gridColor } },
                        x: { ticks: { color: textColor }, grid: { display: false } }
                    }
                }
            });
        }
    </script>
</body>
</html>